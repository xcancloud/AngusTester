<script setup lang="ts">
import { defineAsyncComponent, onMounted, ref } from 'vue';
import { useI18n } from 'vue-i18n';
import { useRoute, useRouter } from 'vue-router';
import { Button, TabPane, Tabs } from 'ant-design-vue';
import { Icon, modal, notification, Select, Spin } from '@xcan-angus/vue-ui';
import YAML from 'yaml';

import { ExecutionInfo } from '../types';
import { exec } from 'src/api/ctrl';
import { Exception } from '@/views/execution/types';

const ExecSetting = defineAsyncComponent(() => import('@/views/execution/detail/Configuration.vue'));
const ExecLog = defineAsyncComponent(() => import('@/views/execution/detail/Log.vue'));
const MonacoEditor = defineAsyncComponent(() => import('@/components/monacoEditor/index.vue'));
const Performance = defineAsyncComponent(() => import('@/views/execution/detail/performance/index.vue'));
const FuncTest = defineAsyncComponent(() => import('@/views/execution/detail/functional/index.vue'));
const TestResult = defineAsyncComponent(() => import('@/views/execution/detail/result/index.vue'));
const ServiceConfig = defineAsyncComponent(() => import('@/views/execution/detail/Server.vue'));

interface Props {
  execId?: string;
  showBackBtn: boolean;
  monicaEditorStyle: {[key: string]:string};
  scriptType?: string;
  plugin?: string;

}
const { t } = useI18n();
const props = withDefaults(defineProps<Props>(), {
  execId: undefined,
  showBackBtn: true,
  monicaEditorStyle: () => ({}),
  scriptType: undefined,
  plugin: undefined
});
const emit = defineEmits<{(e: 'del'):void}>();

const route = useRoute();
const router = useRouter();

const performanceRef = ref();
const funcRef = ref();

const id = props.execId || route.params.id as string;
const pageNo = route.query.pageNo;

const topActiveKey = ref(route.query?.tab === 'log' ? '4' : '1');

const loading = ref(false);
const detail = ref<ExecutionInfo>();
const scriptInfo = ref();
const scriptYamlStr = ref('');

const loadscriptContent = async () => {
  const [error, { data }] = await exec.getScriptByExecId(id);
  if (error) {
    return;
  }
  scriptYamlStr.value = data;
};

const getDetail = async () => {
  loading.value = true;
  const [error, { data }] = await exec.getDetail(id);

  if (error) {
    loading.value = false;
    return;
  }

  detail.value = data;

  if (detail.value?.scriptType.value === 'MOCK_DATA') {
    detail.value.batchRows = detail.value.task?.mockData?.settings.batchRows || '1';
  }

  const { configuration, plugin, task, scriptId, scriptType } = data;
  scriptInfo.value = {
    id: scriptId,
    type: scriptType.value,
    plugin,
    configuration,
    task
  };
};

const getInfo = (data) => {
  if (!data) {
    return;
  }
  const keys = Object.keys(data);
  if (!keys.length || !detail.value) {
    return;
  }

  for (const key in data) {
    detail.value[key] = data[key];
  }

  setException();
};

onMounted(async () => {
  if (!id) {
    const scriptTypeMsgConfig = {
      TEST_PERFORMANCE: t('execution.info.performanceTest'),
      TEST_STABILITY: t('execution.info.stabilityTest'),
      TEST_FUNCTIONALITY: t('execution.info.functionalityTest'),
      TEST_CUSTOMIZATION: t('execution.info.customizationTest')
    };
    if (props.scriptType) {
      detail.value = {
        scriptType: {
          value: props.scriptType,
          message: scriptTypeMsgConfig[props.scriptType] || ''
        }
      };
      if (props.plugin) {
        detail.value.plugin = props.plugin;
      }
      console.log(detail.value);
    }

    return;
  }
  await getDetail();
  setException();
});

const handleRestart = async (item:ExecutionInfo) => {
  if (['TEST_PERFORMANCE', 'TEST_STABILITY'].includes(detail.value?.scriptType.value) && performanceRef.value) {
    performanceRef.value.resetData();
  }

  if (detail.value?.scriptType.value === 'MOCK_DATA') {
    performanceRef.value.restartMock();
  }

  exception.value = undefined;
  const _params = {
    broadcast: true,
    id: item.id
  };
  loading.value = true;
  const [error, { data }] = await exec.restart(_params);

  if (error) {
    loading.value = false;
    if (error?.message) {
      exception.value = { code: error?.code, message: error.message, codeName: t('execution.info.exitCode'), messageName: t('execution.info.failureReason') };
    }
    return;
  }

  const currItemDataList = data.filter(f => f.execId === item.id);
  if (currItemDataList.length) {
    const successFalseItem = currItemDataList.find(f => f.success);
    if (successFalseItem) {
      notification.success(t('execution.info.startSuccess'));
      exception.value = undefined;
    } else {
      notification.error(currItemDataList[0].message);
      exception.value = { code: currItemDataList[0]?.exitCode, message: currItemDataList[0]?.message, codeName: t('execution.info.exitCode'), messageName: t('execution.info.failureReason') };
    }
  }

  await getDetail();
  setException();
};

const handleStop = async (item:ExecutionInfo) => {
  exception.value = undefined;
  const _params = {
    broadcast: true,
    id: item.id
  };
  loading.value = true;
  const [error, { data }] = await exec.stop(_params);
  loading.value = false;
  if (error) {
    if (error?.message) {
      exception.value = { code: error?.code || '', message: error.message, codeName: t('execution.info.exitCode'), messageName: t('execution.info.failureReason') };
    }
    return;
  }

  const currItemDataList = data.filter(f => f.execId === item.id);
  if (currItemDataList.length) {
    const successFalseItem = currItemDataList.find(f => f.success);
    if (successFalseItem) {
      notification.success(t('execution.info.stopSuccess'));
      exception.value = undefined;
    } else {
      notification.error(currItemDataList[0].message);
      exception.value = { code: currItemDataList[0]?.exitCode, message: currItemDataList[0]?.message, codeName: t('execution.info.exitCode'), messageName: t('execution.info.failureReason') };
    }
  }

  await getDetail();
  setException();
};

const handleDelete = async (item:ExecutionInfo) => {
  modal.confirm({
    centered: true,
    content: t('execution.info.deleteConfirm', { name: item.name }),
    async onOk () {
      loading.value = true;
      const [error] = await exec.delete([item.id]);
      loading.value = false;
      if (error) {
        return;
      }
      notification.success(t('execution.info.deleteSuccess'));
      if (props.showBackBtn) {
        router.push('/execution');
      } else {
        emit('del');
      }
    }
  });
};

const topTabsChange = (value:string) => {
  if (value === '3' && !scriptYamlStr.value) {
    loadscriptContent();
  }
};

const languageOpt = [
  {
    value: 'yaml',
    label: 'YAML'
  },
  {
    value: 'json',
    label: 'JSON'
  }
];

const scriptLanguageType = ref('yaml');
const scriptTypeChange = (value:'json' | 'yaml') => {
  scriptLanguageType.value = value;
  if (scriptYamlStr.value) {
    scriptYamlStr.value = value === 'json'
      ? JSON.stringify(YAML.parse(scriptYamlStr.value), null, 4)
      : YAML.stringify(YAML.parse(scriptYamlStr.value));
  }
};

const exception = ref<Exception>();

const setException = () => {
  const lastSchedulingResult = detail.value?.lastSchedulingResult;
  const meterMessage = detail.value?.meterMessage;
  if (lastSchedulingResult?.length) {
    const foundItem = lastSchedulingResult.find(f => !f.success);
    if (foundItem) {
      exception.value = { code: foundItem.exitCode, message: foundItem.message, codeName: t('execution.info.exitCode'), messageName: t('execution.info.failureReason') };
      return;
    }

    if (meterMessage) {
      exception.value = { code: detail.value?.meterStatus || '', message: meterMessage, codeName: t('execution.info.samplingStatus'), messageName: t('execution.info.failureReason') };
      return;
    }
  }

  if (meterMessage) {
    exception.value = { code: detail.value?.meterStatus || '', message: meterMessage, codeName: t('execution.info.samplingStatus'), messageName: t('execution.info.failureReason') };
    return;
  }

  exception.value = undefined;
};
</script>
<template>
  <Spin class="h-full pb-3.5" :spinning="loading">
    <Tabs
      v-model:activeKey="topActiveKey"
      class="h-full flex flex-col header-tabs"
      size="small"
      @change="topTabsChange">
      <template #rightExtra>
        <template v-if="topActiveKey === '1'">
          <template v-if="detail && ['CREATED','STOPPED','FAILED','COMPLETED','TIMEOUT'].includes(detail?.status?.value) && detail?.hasOperationPermission">
            <Button
              size="small"
              type="link"
              class="mr-5 node-action-btn"
              @click="handleRestart(detail)">
              <Icon
                icon="icon-huifu"
                class="mr-1 -mt-0.5 text-3" />
              {{ t('execution.info.start') }}
            </Button>
          </template>
          <template v-if="detail && ['PENDING','RUNNING'].includes(detail?.status?.value) && detail?.hasOperationPermission">
            <Button
              type="link"
              size="small"
              class="mr-5 node-action-btn"
              @click="handleStop(detail)">
              <Icon
                icon="icon-jinyong"
                class="mr-1 -mt-0.5 text-3" />
              {{ t('execution.info.stop') }}
            </Button>
          </template>
          <template v-if="detail?.hasOperationPermission">
            <Button
              type="link"
              size="small"
              class="mr-5 node-action-btn"
              @click="handleDelete(detail)">
              <Icon
                icon="icon-qingchu"
                class="mr-1 -mt-0.5 text-3" />
              {{ t('actions.delete') }}
            </Button>
          </template>
        </template>
        <RouterLink :to="pageNo ? `/execution?pageNo=${pageNo}` : `/execution`">
          <Button
            v-show="props.showBackBtn"
            class="node-action-btn"
            size="small"
            type="link">
            <Icon
              icon="icon-fanhui"
              class="mr-1 -mt-0.5 text-3" />
            {{ t('execution.info.back') }}
          </Button>
        </RouterLink>
      </template>
      <TabPane
        key="1"
        :tab="t('execution.info.executionDetails')">
        <Performance
          v-if="detail && ['TEST_PERFORMANCE','TEST_STABILITY', 'MOCK_DATA', 'TEST_CUSTOMIZATION'].includes(detail.scriptType.value)"
          ref="performanceRef"
          v-model:loading="loading"
          :detail="detail"
          :exception="exception"
          @loaded="getInfo" />
        <FuncTest
          v-else-if="detail && detail.scriptType.value==='TEST_FUNCTIONALITY'"
          ref="funcRef"
          v-model:loading="loading"
          :execInfo="detail"
          :exception="exception"
          @loaded="getInfo" />
      </TabPane>
      <TabPane key="2" :tab="t('execution.info.executionConfig')">
        <ExecSetting
          v-model:loading="loading"
          :execId="id"
          :execName="detail?.name"
          :scriptInfo="scriptInfo" />
      </TabPane>
      <TabPane
        v-if="detail?.plugin === 'Http'"
        key="serviceConfig"
        :tab="t('execution.info.serverConfig')">
        <ServiceConfig :execId="id" />
      </TabPane>
      <TabPane key="3" :tab="t('execution.info.executionScript')">
        <Select
          :value="scriptLanguageType"
          class="w-40 mb-2"
          :allowClear="false"
          :options="languageOpt"
          @change="scriptTypeChange" />
        <MonacoEditor
          :value="scriptYamlStr"
          class="w-full"
          style="height: calc(100% - 36px);"
          :style="props.monicaEditorStyle"
          :isFormat="true"
          :readOnly="true"
          :language="scriptLanguageType" />
      </TabPane>
      <TabPane key="4" :tab="t('execution.info.log')">
        <ExecLog
          v-model:loading="loading"
          :execId="detail?.id"
          :execNodes="detail?.execNodes || []"
          :schedulingNum="detail?.schedulingNum"
          :lastSchedulingDate="detail?.lastSchedulingDate"
          :lastSchedulingResult="detail?.lastSchedulingResult || []" />
      </TabPane>
      <TabPane
        v-if="detail?.plugin === 'Http' && ['API', 'SCENARIO'].includes(detail.scriptSource?.value) && detail.status.value === 'COMPLETED'"
        key="5"
        :tab="t('execution.info.testResult')">
        <TestResult
          :execId="detail?.id"
          :execInfo="detail" />
      </TabPane>
    </Tabs>
  </Spin>
</template>
<style scoped>
.header-tabs > :deep(.ant-tabs-content-holder) {
  @apply overflow-y-auto px-5;
}

.header-tabs > :deep(.ant-tabs-nav ){
  @apply h-10 pr-5 font-medium;

  background-image: linear-gradient(to bottom, rgb(255, 255, 255) 13%, rgb(245, 251, 255) 100%);
}

.header-tabs > :deep(.ant-tabs-nav > .ant-tabs-nav-wrap) {
  @apply pl-5;
}

.node-action-btn {
  @apply rounded mr-2 text-text-content text-3 border-0  px-2 shadow-none inline-flex items-center;
}

.node-action-btn :deep(span) {
  @apply ml-1;
}

.node-action-btn[disabled],
.node-action-btn:not([disabled]),
.node-action-btn:focus {
  @apply bg-transparent !important;
}

.node-action-btn[disabled] {
  @apply opacity-50;
}

.node-action-btn:not([disabled]):hover {
  @apply text-text-link;
}

.node-action-btn::after {
  @apply hidden;
}
</style>
