<script setup lang="ts">
import { ref, onMounted, onBeforeUnmount, nextTick, computed, watch, withDefaults } from 'vue';
import { Radio, RadioGroup, RadioButton } from 'ant-design-vue';
import { useI18n } from 'vue-i18n';
import { EffectivenessProps, BurnDownDataByType } from './types';
import { useEffectivenessData } from './composables/useEffectivenessData';
import { useEffectivenessConfig } from './composables/useEffectivenessConfig';
import { useChartManagement } from './composables/useChartManagement';
import { useEffectivenessLifecycle } from './composables/useEffectivenessLifecycle';

// Component props with defaults
const props = withDefaults(defineProps<EffectivenessProps>(), {
  onShow: true
});

// Internationalization
const { t } = useI18n();

// Chart DOM references
const taskTypeChartRef = ref<HTMLElement>();
const burnDownChartRef = ref<HTMLElement>();
const targetCountChartRef = ref<HTMLElement>();
const workloadChartRef = ref<HTMLElement>();
const overdueChartRef = ref<HTMLElement>();
const oneTimePassedTestChartRef = ref<HTMLElement>();
const assigneeRankingChartRef = ref<HTMLElement>();
const testerRankingChartRef = ref<HTMLElement>();

// Initialize composables
const {
  overviewData,
  burnDownData,
  totalTypeData,
  assigneeRanking,
  testerRanking,
  assignees,
  testers,
  loadEffectivenessData
} = useEffectivenessData(props);

const {
  initializeCharts,
  resizeAllCharts,
  updateTaskTypeChart,
  updateBurnDownChart,
  updateRankingCharts
} = useChartManagement();

const {
  isNormalSize,
  setupLifecycle,
  cleanup
} = useEffectivenessLifecycle(props, loadEffectivenessData, () => resizeAllCharts());

// Initialize configuration
const { currentOverviewConfig } = useEffectivenessConfig(props.countType);

// Local state
const burnDownOption = ref<'NUM' | 'WORKLOAD'>('NUM');

// Event handlers
const handleBurnDownOptionChange = () => {
  nextTick(() => {
    if (burnDownData.value) {
      updateBurnDownChart(burnDownData.value as BurnDownDataByType, burnDownOption.value);
    }
  });
};

// Lifecycle hooks
onMounted(async () => {
  setupLifecycle();

  watch(() => props.projectId, async () => {
    if (props.projectId) {
      await loadEffectivenessData();
      await nextTick();
      initializeCharts({
        taskTypeRef: taskTypeChartRef.value as HTMLElement,
        burnDownRef: burnDownChartRef.value as HTMLElement,
        targetCountRef: targetCountChartRef.value as HTMLElement,
        workloadRef: workloadChartRef.value as HTMLElement,
        overdueRef: overdueChartRef.value as HTMLElement,
        oneTimePassedTestRef: oneTimePassedTestChartRef.value as HTMLElement,
        assigneeRankingRef: assigneeRankingChartRef.value as HTMLElement,
        testerRankingRef: testerRankingChartRef.value as HTMLElement
      });
    }
  }, { immediate: true });
});

onBeforeUnmount(() => {
  cleanup();
});

// Watch for data changes and update charts
watch([overviewData, burnDownData, totalTypeData, assigneeRanking, testerRanking], async () => {
  if (props.onShow) {
    await nextTick();

    // Update available charts with new data
    if (totalTypeData.value) {
      updateTaskTypeChart(totalTypeData.value);
    }
    if (burnDownData.value) {
      updateBurnDownChart(burnDownData.value as BurnDownDataByType, burnDownOption.value);
    }
    if (assigneeRanking.value && assignees.value) {
      updateRankingCharts(assigneeRanking.value, assignees.value, props.countType);
    }
  }
}, { deep: true });

// Watch for countType changes to update task type chart
watch(() => props.countType, async () => {
  if (props.onShow && totalTypeData.value) {
    await nextTick();
    updateTaskTypeChart(totalTypeData.value);
  }
});
</script>

<template>
  <div class="effectiveness-dashboard">
    <!-- Overview Section -->
    <div class="overview-section">
      <div class="overview-grid">
        <div
          v-for="(row, rowIndex) in currentOverviewConfig"
          :key="rowIndex"
          class="overview-row">
          <div
            v-for="(item, itemIndex) in row"
            :key="itemIndex"
            class="overview-item">
            <div class="overview-icon">
              <i :class="item.icon"></i>
            </div>
            <div class="overview-content">
              <div class="overview-value">
                {{ overviewData[item.dataIndex] || 0 }}
                <span v-if="item.unit" class="overview-unit">{{ item.unit }}</span>
              </div>
              <div class="overview-label">{{ item.name }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
      <!-- Task Type Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>{{ $t('kanban.effectiveness.taskTypeTitle') }}</h3>
        </div>
        <div ref="taskTypeChartRef" class="chart-content"></div>
      </div>

      <!-- Burn Down Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>{{ $t('kanban.effectiveness.burnDownChart') }}</h3>
          <div class="chart-controls">
            <RadioGroup
              v-model:value="burnDownOption"
              size="small"
              @change="handleBurnDownOptionChange">
              <RadioButton value="NUM">{{ props.countType === 'task' ? t('kanban.effectiveness.taskNumber') : t('kanban.effectiveness.testNumber') }}</RadioButton>
              <RadioButton value="WORKLOAD">{{ t('kanban.effectiveness.workload') }}</RadioButton>
            </RadioGroup>
          </div>
        </div>
        <div ref="burnDownChartRef" class="chart-content"></div>
      </div>

      <!-- Target Count Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>{{ $t('kanban.effectiveness.targetCount') }}</h3>
        </div>
        <div ref="targetCountChartRef" class="chart-content"></div>
      </div>

      <!-- Workload Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>{{ $t('kanban.effectiveness.workload') }}</h3>
        </div>
        <div ref="workloadChartRef" class="chart-content"></div>
      </div>

      <!-- Overdue Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>{{ $t('kanban.effectiveness.overdue') }}</h3>
        </div>
        <div ref="overdueChartRef" class="chart-content"></div>
      </div>

      <!-- One Time Passed Test Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>{{ $t('kanban.effectiveness.oneTimePassedTest') }}</h3>
        </div>
        <div ref="oneTimePassedTestChartRef" class="chart-content"></div>
      </div>

      <!-- Ranking Charts -->
      <div class="ranking-charts">
        <div class="chart-container">
          <div class="chart-header">
            <h3>{{ $t('kanban.effectiveness.assigneeRanking') }}</h3>
          </div>
          <div ref="assigneeRankingChartRef" class="chart-content"></div>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <h3>{{ $t('kanban.effectiveness.testerRanking') }}</h3>
          </div>
          <div ref="testerRankingChartRef" class="chart-content"></div>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
.effectiveness-dashboard {
  padding: 20px;
}

.overview-section {
  margin-bottom: 30px;
}

.overview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.overview-row {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.overview-item {
  display: flex;
  align-items: center;
  padding: 15px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.overview-icon {
  margin-right: 15px;
  font-size: 24px;
  color: #1890ff;
}

.overview-content {
  flex: 1;
}

.overview-value {
  font-size: 24px;
  font-weight: bold;
  color: #262626;
  margin-bottom: 5px;
}

.overview-unit {
  font-size: 14px;
  color: #8c8c8c;
  margin-left: 5px;
}

.overview-label {
  font-size: 14px;
  color: #8c8c8c;
}

.charts-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}

.chart-container {
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  border-bottom: 1px solid #f0f0f0;
}

.chart-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #262626;
}

.chart-controls {
  display: flex;
  align-items: center;
}

.chart-content {
  height: 300px;
  padding: 20px;
}

.ranking-charts {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}

@media (max-width: 1440px) {
  .charts-section {
    grid-template-columns: 1fr;
  }

  .ranking-charts {
    grid-template-columns: 1fr;
  }
}
</style>
