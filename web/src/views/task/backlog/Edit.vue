<script setup lang="ts">
import { computed, defineAsyncComponent, onMounted, reactive, ref, watch } from 'vue';
import { useI18n } from 'vue-i18n';
import { Button, Form, FormItem, Popover, TreeSelect, Upload } from 'ant-design-vue';
import type { Rule } from 'ant-design-vue/es/form';
import {
  AsyncComponent, DatePicker, Icon, IconTask, IconText, Input,
  Modal, notification, Select, SelectUser, TaskPriority, Tooltip
} from '@xcan-angus/vue-ui';
import { EvalWorkloadMethod, localStore, Priority, TESTER, upload } from '@xcan-angus/infra';
import dayjs, { Dayjs } from 'dayjs';
import { cloneDeep, isEqual } from 'lodash-es';
import { modules, task } from '@/api/tester';
import { DATE_TIME_FORMAT, TIME_FORMAT } from '@/utils/constant';
import { BugLevel, SoftwareVersionStatus, TaskType, TestType } from '@/enums/enums';
import { EditFormState } from '@/views/task/task/list/task/types';

import SelectEnum from '@/components/enum/SelectEnum.vue';
import { TaskInfo } from '../types';

const RichEditor = defineAsyncComponent(() => import('@/components/richEditor/index.vue'));

const props = withDefaults(defineProps<EditFormState>(), {
  projectId: undefined,
  userInfo: undefined,
  appInfo: undefined,
  sprintId: undefined,
  visible: false,
  taskId: undefined,
  taskType: undefined,
  assigneeId: undefined,
  confirmerId: undefined,
  moduleId: undefined,
  parentTaskId: undefined,
  name: undefined,
  description: undefined,
  refCaseIds: () => []
});

// eslint-disable-next-line func-call-spacing
const emit = defineEmits<{
  (e: 'update:visible', value: boolean): void;
  (e: 'update:taskId', value: string | undefined): void;
  (e: 'ok', value?: Partial<TaskInfo>): void;
}>();

const { t } = useI18n();
const formRef = ref();

const loading = ref<boolean>(false);
const zoomInFlag = ref(false);
const showEditorFlag = ref(false);

const evalWorkloadMethod = ref<EvalWorkloadMethod>(EvalWorkloadMethod.STORY_POINT);
const sprintDeadlineDate = ref<string>();

const moduleTreeData = ref([]);
const getModuleTreeData = async () => {
  if (!props.projectId) {
    return;
  }
  const [error, { data }] = await modules.getModuleTree({
    projectId: props.projectId
  });
  if (error) {
    return;
  }
  moduleTreeData.value = data || [];
};

let oldFormState: EditFormState | undefined;
const formState = reactive<EditFormState>({
  projectId: undefined,
  assigneeId: undefined,
  attachments: undefined,
  confirmerId: undefined,
  deadlineDate: undefined,
  description: undefined,
  evalWorkload: undefined,
  actualWorkload: undefined,
  name: undefined,
  priority: undefined,
  parentTaskId: undefined,
  sprintId: undefined,
  moduleId: undefined,
  tagIds: undefined,
  refTaskIds: undefined,
  refCaseIds: undefined,
  targetId: undefined,
  targetParentId: undefined,
  taskType: undefined,
  testType: undefined,
  bugLevel: BugLevel.MINOR,
  testerId: undefined,
  missingBug: false,
  softwareVersion: undefined
});

const assigneeDefaultOptions = ref<{[key:string]:{fullName:string;id:string;}}>();
const confirmerDefaultOptions = ref<{[key:string]:{fullName:string;id:string;}}>();

const showContinue = computed(() => {
  return !props.taskId && !props.taskType;
});

const zoomToggle = () => {
  zoomInFlag.value = !zoomInFlag.value;
  localStore.set(zoomInFlagCacheKey.value, zoomInFlag.value);
};

const sprintChange = (_id: string, option: TaskInfo) => {
  formState.deadlineDate = option?.deadlineDate || '';
  sprintDeadlineDate.value = formState.deadlineDate;
  evalWorkloadMethod.value = option?.evalWorkloadMethod?.value;
};

const taskTypeChange = () => {
  formState.targetParentId = undefined;
  formState.targetId = undefined;
  if (!formState.testerId && formState.taskType === TaskType.BUG) {
    formState.testerId = userId.value;
  }
};

const assignToMe = (key:'assigneeId'|'confirmerId'|'testerId') => {
  if (key === 'assigneeId') {
    formState.assigneeId = userId.value;
    return;
  }
  if (key === 'confirmerId') {
    formState.confirmerId = userId.value;
  }
  if (key === 'testerId') {
    formState.testerId = userId.value;
  }
};

const evalWorkloadValidateDate = async (_rule: Rule, value: string) => {
  if (!props.taskId) {
    return;
  }

  if (formState.actualWorkload) {
    if (!value) {
      return Promise.reject(new Error(t('backlog.messages.inputEvalWorkload')));
    }
    return Promise.resolve();
  }
  return Promise.resolve();
};

const actualWorkloadChange = (value: string) => {
  if (!value) {
    formRef.value.clearValidate('evalWorkload');
  }
};

const evalWorkloadChange = (value: string) => {
  if (!value) {
    formState.actualWorkload = '';
    formRef.value.clearValidate('evalWorkload');
  }
};

const validateDate = async (_rule: Rule, value: string) => {
  if (dayjs(value).isBefore(dayjs(), 'minute')) {
    return Promise.reject(new Error(t('backlog.messages.deadlineMustBeFuture')));
  }

  if (sprintDeadlineDate.value) {
    if (dayjs(value).isAfter(dayjs(sprintDeadlineDate.value), 'seconds')) {
      return Promise.reject(new Error(t('backlog.editForm.messages.sprintDeadlineExceeded', { deadline: sprintDeadlineDate.value })));
    }
  }
  return Promise.resolve();
};

const disabledDate = (current: Dayjs) => {
  const today = dayjs().startOf('day');
  return current.isBefore(today, 'day');
};

const editorChange = (value: string) => {
  formState.description = value;
};

const editorLoading = (value: boolean) => {
  loading.value = value;
};

const upLoad = async function ({ file }: { file: File }) {
  if (!formState.attachments || formState.attachments.length >= 5 || loading.value) {
    return;
  }

  loading.value = true;
  const [error, { data = [] }] = await upload(file.originFileObj, { bizKey: 'angusTesterTaskAttachments' });
  loading.value = false;
  if (error) {
    return;
  }

  if (data && data.length > 0) {
    const attachments = data?.map(item => ({ name: item.name, url: item.url }));
    formState.attachments.push(...attachments);
  }
};

const delFile = (index: number) => {
  formState?.attachments?.splice(index, 1);
};

const isValid = async () => {
  const ruleKeys = [
    'name'
  ];

  if (formState.actualWorkload) {
    ruleKeys.push('evalWorkload');
  }

  return new Promise((resolve) => {
    formRef.value.validate(ruleKeys).then(async () => {
      return resolve(true);
    }).catch((errors:{errorFields:{errors:string[];name:string[];warnings:string;}[]}) => {
      if (errors.errorFields.length === 1) {
        const names = errors.errorFields[0].name;
        if (names.length === 1 && names[0] === 'deadlineDate') {
          return resolve(true);
        }
      }

      return resolve(false);
    });
  });
};

const getParams = () => {
  const params: EditFormState = {
    projectId: props.projectId,
    sprintId: formState.sprintId,
    name: formState.name,
    taskType: formState.taskType,
    assigneeId: formState.assigneeId,
    deadlineDate: formState.deadlineDate,
    priority: formState.priority,
    parentTaskId: formState.parentTaskId,
    testerId: formState.testerId,
    softwareVersion: formState.softwareVersion
  };

  if (props.parentTaskId) {
    params.parentTaskId = props.parentTaskId;
  }

  if (formState.confirmerId) {
    params.confirmerId = formState.confirmerId;
  }

  if (formState.moduleId && +formState.moduleId > 0) {
    params.moduleId = formState.moduleId;
  }

  if (formState.tagIds?.length) {
    params.tagIds = formState.tagIds;
  }

  if (formState.refTaskIds?.length) {
    params.refTaskIds = formState.refTaskIds;
  }

  if (formState.refCaseIds?.length) {
    params.refCaseIds = formState.refCaseIds;
  }

  if (formState.description) {
    params.description = formState.description;
  }

  if (formState.attachments?.length) {
    params.attachments = formState.attachments;
  }

  if (formState.evalWorkload) {
    params.evalWorkload = formState.evalWorkload;
  }

  if (props.taskId && formState.actualWorkload) {
    params.actualWorkload = formState.actualWorkload;
  }

  if (formState.taskType === TaskType.BUG) {
    params.bugLevel = formState.bugLevel;
    params.missingBug = formState.missingBug;
  }

  if (formState.taskType === TaskType.API_TEST) {
    params.testType = formState.testType;
    params.targetId = formState.targetId;
    params.targetParentId = formState.targetParentId;
  }

  if (formState.taskType === TaskType.SCENARIO_TEST) {
    params.testType = formState.testType;
    params.targetId = formState.targetId;
  }

  return params;
};

const submit = async (continueFlag: boolean) => {
  if (props.taskId) {
    const equalFlag = isEqual(oldFormState, formState);
    if (equalFlag) {
      emit('update:visible', false);
      return;
    }
  }

  const descriptionValidFlag = !formState.description || formState.description?.length <= 8000;
  const validFlag = await isValid();
  if (!validFlag || !descriptionValidFlag) {
    return;
  }

  if (!props.taskId) {
    createHandler(continueFlag);
    return;
  }

  editHandler();
};

const createHandler = async (continueFlag = false) => {
  loading.value = true;
  const params = getParams();
  const [error, res] = await task.addTask(params);
  loading.value = false;
  if (error) {
    return;
  }

  notification.success(t('backlog.editForm.messages.taskAddedSuccess'));
  emit('ok', res?.data);

  if (!continueFlag) {
    cancel();
  }
};

const editHandler = async () => {
  loading.value = true;
  const params = getParams();
  const [error] = await task.putTask(props.taskId, params);
  loading.value = false;
  if (error) {
    return;
  }

  notification.success(t('backlog.editForm.messages.taskEditedSuccess'));
  const data = await loadData();
  emit('ok', data);
  cancel();
};

const cancel = () => {
  emit('update:taskId', undefined);
  emit('update:visible', false);
};

const loadData = async (): Promise<Partial<TaskInfo>> => {
  loading.value = true;
  const [error, res] = await task.getTaskDetail(props.taskId);
  loading.value = false;
  if (error || !res?.data) {
    return { id: props.taskId! };
  }

  return res.data;
};

const initialize = () => {
  zoomInFlag.value = !!localStore.get(zoomInFlagCacheKey.value);
};

const resetDefault = () => {
  loading.value = false;
  showEditorFlag.value = false;
  evalWorkloadMethod.value = EvalWorkloadMethod.STORY_POINT;
  sprintDeadlineDate.value = undefined;

  oldFormState = undefined;
  formState.attachments = [];
  formState.deadlineDate = dayjs().add(1, 'day').format(DATE_TIME_FORMAT);
  if (dayjs(formState.deadlineDate).hour() > 19 || dayjs(formState.deadlineDate).hour() < 8) {
    formState.deadlineDate = dayjs(formState.deadlineDate).add(12, 'hour').format(DATE_TIME_FORMAT);
  }
  formState.description = props.description || '';
  formState.evalWorkload = '';
  formState.actualWorkload = '';
  formState.name = props.name || '';
  formState.priority = Priority.MEDIUM;
  formState.bugLevel = BugLevel.MINOR;
  formState.parentTaskId = undefined;
  formState.sprintId = props.sprintId;
  formState.tagIds = [];
  formState.refTaskIds = [];
  formState.refCaseIds = props.refCaseIds || [];
  formState.targetId = undefined;
  formState.targetParentId = undefined;
  formState.taskType = props.taskType || TaskType.TASK;
  formState.testType = TestType.FUNCTIONAL;
  formState.missingBug = false;
  formState.softwareVersion = undefined;
  formState.assigneeId = props.assigneeId || props.userInfo?.id || undefined;
  formState.testerId = props.taskType === TaskType.BUG ? props.userInfo?.id : undefined;
  formState.confirmerId = props.confirmerId || undefined;
  if (props.moduleId && +props.moduleId > 0) {
    formState.moduleId = props.moduleId;
  } else {
    formState.moduleId = undefined;
  }
};

onMounted(() => {
  initialize();

  watch(() => props.visible, async () => {
    if (props.visible) {
      await getModuleTreeData();
      if (typeof formRef.value?.clearValidate === 'function') {
        await formRef.value.clearValidate();
      }

      if (!props.taskId) {
        resetDefault();
        return;
      }

      const data = await loadData();
      if (!data) {
        resetDefault();
        return;
      }

      const assigneeId = data.assigneeId;
      formState.assigneeId = assigneeId;
      assigneeDefaultOptions.value = {
        [assigneeId]: {
          fullName: data.assigneeName,
          id: assigneeId
        }
      };

      const confirmerId = data.confirmerId;
      formState.confirmerId = confirmerId;
      confirmerDefaultOptions.value = {
        [confirmerId]: {
          fullName: data.confirmerName,
          id: confirmerId
        }
      };

      formState.attachments = data.attachments || [];
      formState.moduleId = data.moduleId ? (+data.moduleId < 0 ? undefined : data.moduleId) : undefined;
      formState.deadlineDate = data.deadlineDate;
      formState.description = data.description;
      formState.evalWorkload = data.evalWorkload;
      formState.actualWorkload = data.actualWorkload;
      formState.name = data.name;
      formState.priority = data.priority?.value;
      formState.parentTaskId = data.parentTaskId;
      formState.sprintId = data.sprintId;
      formState.tagIds = data.tags?.map(item => item.id);
      formState.refTaskIds = data.refTaskInfos?.map(item => item.id);
      formState.refCaseIds = data.refCaseInfos?.map(item => item.id);
      formState.targetId = data.targetId;
      formState.taskType = data.taskType?.value;
      formState.testType = data.testType?.value;
      formState.targetParentId = data.targetParentId;
      formState.testerId = data.testerId;
      formState.missingBug = data.missingBug || false;
      formState.bugLevel = data.bugLevel?.value || BugLevel.MINOR;
      formState.softwareVersion = data.softwareVersion;

      oldFormState = cloneDeep(formState);

      evalWorkloadMethod.value = data.evalWorkloadMethod?.value;
      showEditorFlag.value = true;
    }
  }, { immediate: true });
});

const taskTypeExcludes = (data: { value: TaskInfo['taskType']['value']; message: string }) => {
  const value = data.value;
  const type = formState.taskType;
  if (props.taskId) {
    if (type === TaskType.API_TEST) {
      return value !== TaskType.API_TEST;
    }
    if (type === TaskType.SCENARIO_TEST) {
      return value !== TaskType.SCENARIO_TEST;
    }
    return [TaskType.API_TEST, TaskType.SCENARIO_TEST].includes(value);
  }
  return false;
};

const taskIdExcludes = (data: { id: string }) => {
  return props.taskId === data.id;
};

const userId = computed(() => {
  return props.userInfo?.id;
});

const title = computed(() => {
  if (props.taskId) {
    return t('backlog.editForm.title.edit');
  }
  return t('backlog.editForm.title.add');
});

const taskTypeReadonly = computed(() => {
  return (
    props.taskId && (formState.taskType === TaskType.API_TEST || formState.taskType === TaskType.SCENARIO_TEST)
  ) || !!props.taskType;
});

const showEditor = computed(() => {
  return props.visible && (showEditorFlag.value || !props.taskId);
});

const showTestType = computed(() => {
  const taskType = formState.taskType;
  if (!taskType) {
    return false;
  }
  return [TaskType.API_TEST, TaskType.SCENARIO_TEST].includes(taskType);
});

const descRichRef = ref();
const validateDesc = async () => {
  if (descRichRef.value && descRichRef.value.getLength() > 6000) {
    return Promise.reject(new Error(t('backlog.editForm.messages.descriptionMaxLength')));
  }
  return Promise.resolve();
};

const modalStyle = computed(() => {
  if (zoomInFlag.value) {
    return {
      width: '100%'
    };
  }
  return {
    width: '1000px'
  };
});

const formStyle = computed(() => {
  if (zoomInFlag.value) {
    return {
      height: '86vh'
    };
  }
  return {
    height: '75vh',
    minHeight: '665px'
  };
});

const zoomInFlagCacheKey = computed(() => {
  return `${props.userInfo?.id}${props?.projectId}${btoa('modalSize')}`;
});
</script>
<template>
  <Modal
    :title="title"
    :centered="true"
    :style="modalStyle"
    :visible="props.visible"
    class="relative max-w-full"
    @cancel="cancel">
    <Tooltip :title="zoomInFlag ? t('backlog.zoomOut') : t('backlog.zoomIn')">
      <Icon
        :icon="zoomInFlag ? 'icon-tuichuzuida' : 'icon-zuidahua'"
        class="absolute right-10 top-3.5 text-3.5 cursor-pointer"
        @click="zoomToggle" />
    </Tooltip>

    <Form
      ref="formRef"
      :model="formState"
      :labelCol="{style: {width: '90px'}}"
      layout="vertical"
      class="overflow-y-auto overflow-x-hidden"
      size="small"
      :style="formStyle">
      <div class="flex">
        <div class="flex-1 pr-8">
          <FormItem
            name="name"
            :label="t('backlog.columns.name')"
            :rules="{ required: true, message: t('backlog.messages.taskNameRequired') }">
            <Input
              v-model:value="formState.name"
              trim
              :maxlength="200"
              :placeholder="t('backlog.placeholder.taskName')" />
          </FormItem>

          <div class="flex space-x-4">
            <FormItem
              v-if="!!formState.taskType"
              name="taskType"
              class="flex-1/2"
              required>
              <template #label>
                {{ t('backlog.editForm.labels.type') }}
                <Popover>
                  <template #content>
                    <div class="flex items-center leading-5">
                      <div class="space-y-2 flex-shrink-0">
                        <div class="flex items-center">
                          <IconTask :value="TaskType.REQUIREMENT" class="mr-1 text-4" />
                          <span>{{ t('backlog.editForm.taskTypes.requirement') }}</span>
                        </div>
                        <div class="flex items-center">
                          <IconTask :value="TaskType.STORY" class="mr-1 text-4" />
                          <span>{{ t('backlog.editForm.taskTypes.story') }}</span>
                        </div>
                        <div class="flex items-center">
                          <IconTask :value="TaskType.TASK" class="mr-1 text-4" />
                          <span>{{ t('backlog.editForm.taskTypes.task') }}</span>
                        </div>
                        <div class="flex items-center">
                          <IconTask :value="TaskType.BUG" class="mr-1 text-4" />
                          <span>{{ t('backlog.editForm.taskTypes.bug') }}</span>
                        </div>
                        <div class="flex items-center">
                          <IconTask :value="TaskType.API_TEST" class="mr-1 text-4" />
                          <span>{{ t('backlog.editForm.taskTypes.apiTest') }}</span>
                        </div>
                        <div class="flex items-center">
                          <IconTask :value="TaskType.SCENARIO_TEST" class="mr-1 text-4" />
                          <span>{{ t('backlog.editForm.taskTypes.scenarioTest') }}</span>
                        </div>
                      </div>
                      <div class="ml-3.5 space-y-2">
                        <div>{{ t('backlog.editForm.taskTypeDescriptions.requirement') }}</div>
                        <div>{{ t('backlog.editForm.taskTypeDescriptions.story') }}</div>
                        <div>{{ t('backlog.editForm.taskTypeDescriptions.task') }}</div>
                        <div>{{ t('backlog.editForm.taskTypeDescriptions.bug') }}</div>
                        <div>{{ t('backlog.editForm.taskTypeDescriptions.apiTest') }}</div>
                        <div>{{ t('backlog.editForm.taskTypeDescriptions.scenarioTest') }}</div>
                      </div>
                    </div>
                  </template>
                  <Icon icon="icon-tishi1" class="text-tips ml-1 cursor-pointer text-3.5" />
                </Popover>
              </template>

              <SelectEnum
                v-model:value="formState.taskType"
                :allowClear="false"
                :excludes="taskTypeExcludes"
                :readonly="taskTypeReadonly"
                internal
                enumKey="TaskType"
                :placeholder="t('backlog.editForm.placeholders.selectTaskType')"
                style="width: 280px;"
                @change="taskTypeChange">
                <template #option="record">
                  <div class="flex items-center">
                    <IconTask :value="record.value" class="text-4 flex-shrink-0" />
                    <span class="ml-1">{{ record.message }}</span>
                  </div>
                </template>
              </SelectEnum>
            </FormItem>

            <FormItem
              name="priority"
              :label="t('backlog.editForm.labels.priority')"
              class="flex-1/2"
              required>
              <SelectEnum
                v-model:value="formState.priority"
                :allowClear="false"
                internal
                enumKey="Priority"
                :placeholder="t('backlog.editForm.placeholders.selectPriority')">
                <template #option="record">
                  <TaskPriority :value="record" />
                </template>
              </SelectEnum>
            </FormItem>
          </div>

          <template v-if="formState.taskType === TaskType.BUG">
            <div class="flex space-x-4">
              <FormItem
                name="bugLevel"
                :label="t('backlog.editForm.labels.bugLevel')"
                class="flex-1/2">
                <SelectEnum
                  v-model:value="formState.bugLevel"
                  enumKey="BugLevel"
                  style="width: 280px;"
                  :allowClear="false"
                  :lazy="false" />
              </FormItem>
              <FormItem
                name="missingBug"
                :label="t('backlog.editForm.labels.missingBug')"
                class="flex-1/2">
                <Select
                  v-model:value="formState.missingBug"
                  :options="[{value: true, label: t('status.yes')}, {value: false, label: t('status.no')}]">
                </Select>
              </FormItem>
            </div>
          </template>

          <div v-if="formState.taskType === TaskType.SCENARIO_TEST" class="flex space-x-4">
            <FormItem
              name="targetId"
              :label="t('backlog.editForm.labels.scenario')"
              class="flex-1 min-w-0"
              :rules="{ required: true, message: t('backlog.editForm.messages.selectScenario') }">
              <Select
                v-model:value="formState.targetId"
                showSearch
                internal
                :placeholder="t('backlog.editForm.placeholders.selectScenario')"
                :fieldNames="{ label: 'name', value: 'id' }"
                :action="`${TESTER}/scenario?projectId=${props.projectId}&fullTextSearch=true`"
                :readonly="!!props.taskId" />
            </FormItem>

            <FormItem
              v-if="showTestType"
              name="testType"
              :label="t('backlog.editForm.labels.testType')"
              class="flex-1"
              required>
              <SelectEnum
                v-model:value="formState.testType"
                :allowClear="false"
                internal
                enumKey="TestType"
                :placeholder="t('backlog.editForm.placeholders.selectTestType')"
                style="width: 280px;" />
            </FormItem>
          </div>

          <template v-if="formState.taskType === TaskType.API_TEST">
            <FormItem
              name="targetParentId"
              :label="t('backlog.editForm.labels.service')"
              :rules="{ required: true, message: t('backlog.editForm.messages.selectService') }">
              <Select
                v-model:value="formState.targetParentId"
                :action="`${TESTER}/services?projectId=${props.projectId}&fullTextSearch=true`"
                :fieldNames="{ value: 'id', label: 'name' }"
                :readonly="!!props.taskId"
                :lazy="false"
                internal
                defaultActiveFirstOption
                showSearch
                :placeholder="t('backlog.editForm.placeholders.selectOrSearchService')">
                <template #option="record">
                  <div class="text-3 leading-3 flex items-center h-6.5">
                    <IconText
                      class="mr-1"
                      style="width:16px;height: 16px;"
                      :text="record.targetType?.value === 'PROJECT' ? 'P' : 'S'"
                      :class="record.targetType?.value === 'PROJECT' ? 'bg-blue-badge-p' : 'bg-blue-badge-s'" />
                    <div :title="record.name" class="truncate">{{ record.name }}</div>
                  </div>
                </template>
              </Select>
            </FormItem>

            <div class="flex space-x-4">
              <FormItem
                :label="t('backlog.editForm.labels.api')"
                name="targetId"
                class="flex-1 min-w-0"
                :rules="{ required: true, message: t('backlog.editForm.messages.selectApi') }">
                <Select
                  v-model:value="formState.targetId"
                  showSearch
                  internal
                  :placeholder="t('backlog.editForm.placeholders.selectApi')"
                  :fieldNames="{ label: 'summary', value: 'id' }"
                  :action="`${TESTER}/apis?projectId=${props.projectId}&serviceId=${formState.targetParentId}&fullTextSearch=true`"
                  :readonly="!!props.taskId || !formState.targetParentId" />
              </FormItem>

              <FormItem
                v-if="showTestType"
                name="testType"
                :label="t('backlog.editForm.labels.testType')"
                class="flex-1"
                required>
                <SelectEnum
                  v-model:value="formState.testType"
                  :allowClear="false"
                  internal
                  enumKey="TestType"
                  :placeholder="t('backlog.editForm.placeholders.selectTestType')"
                  style="width: 280px;" />
              </FormItem>
            </div>
          </template>

          <div class="flex space-x-4">
            <FormItem
              name="assigneeId"
              class="flex-1/2"
              :rules="{ required: true, message: t('backlog.editForm.messages.selectAssignee') }">
              <template #label>
                {{ t('backlog.editForm.labels.assignee') }}<Popover placement="rightTop">
                  <template #content>
                    <div class="text-3 text-theme-sub-content max-w-75 leading-4">
                      {{ t('backlog.editForm.descriptions.assignee') }}
                    </div>
                  </template>
                  <Icon icon="icon-tishi1" class="text-tips ml-1 text-3.5" />
                </Popover>
              </template>

              <div class="flex items-center ">
                <SelectUser
                  v-model:value="formState.assigneeId"
                  :placeholder="t('backlog.editForm.placeholders.selectAssignee')"
                  internal
                  class="flex-1 min-w-0"
                  :defaultOptions="assigneeDefaultOptions"
                  :action="`${TESTER}/project/${props.projectId}/member/user`"
                  :maxlength="80" />
                <Button
                  size="small"
                  type="link"
                  class="p-0 h-5 leading-5 ml-1"
                  @click="assignToMe('assigneeId')">
                  {{ t('backlog.editForm.buttons.assignToMe') }}
                </Button>
              </div>
            </FormItem>

            <FormItem name="confirmerId" class="flex-1/2">
              <template #label>
                {{ t('backlog.editForm.labels.confirmer') }}<Popover placement="rightTop">
                  <template #content>
                    <div class="text-3 text-theme-sub-content max-w-75 leading-4">
                      {{ t('backlog.editForm.descriptions.confirmer') }}
                    </div>
                  </template>
                  <Icon icon="icon-tishi1" class="text-tips ml-1 text-3.5" />
                </Popover>
              </template>

              <div class="flex items-center">
                <SelectUser
                  v-model:value="formState.confirmerId"
                  :placeholder="t('backlog.editForm.placeholders.selectConfirmer')"
                  internal
                  allowClear
                  class="flex-1 min-w-0"
                  :defaultOptions="confirmerDefaultOptions"
                  :action="`${TESTER}/project/${props.projectId}/member/user`"
                  :maxlength="80" />
                <Button
                  size="small"
                  type="link"
                  class="p-0 h-5 leading-5 ml-1"
                  @click="assignToMe('confirmerId')">
                  {{ t('backlog.editForm.buttons.assignToMe') }}
                </Button>
              </div>
            </FormItem>
          </div>

          <div class="flex space-x-4">
            <FormItem
              :label="t('backlog.editForm.labels.deadline')"
              name="deadlineDate"
              class="flex-1/2"
              :rules="{ required: true, validator: validateDate }">
              <DatePicker
                v-model:value="formState.deadlineDate"
                :showNow="false"
                :disabledDate="disabledDate"
                :showTime="{ hideDisabledOptions: true, format: TIME_FORMAT }"
                type="date"
                size="small"
                showToday
                class="w-full" />
            </FormItem>

            <FormItem name="confirmerId" class="flex-1/2">
              <template #label>
                {{ t('backlog.editForm.labels.tester') }}<Popover placement="rightTop">
                  <template #content>
                    <div class="text-3 text-theme-sub-content max-w-75 leading-4">
                      {{ t('backlog.editForm.descriptions.tester') }}
                    </div>
                  </template>
                  <Icon icon="icon-tishi1" class="text-tips ml-1 text-3.5" />
                </Popover>
              </template>

              <div class="flex items-center">
                <SelectUser
                  v-model:value="formState.testerId"
                  :placeholder="t('backlog.editForm.placeholders.selectTester')"
                  internal
                  allowClear
                  class="flex-1 min-w-0"
                  :defaultOptions="confirmerDefaultOptions"
                  :action="`${TESTER}/project/${props.projectId}/member/user`"
                  :maxlength="80" />
                <Button
                  size="small"
                  type="link"
                  class="p-0 h-5 leading-5 ml-1"
                  @click="assignToMe('testerId')">
                  {{ t('backlog.editForm.buttons.assignToMe') }}
                </Button>
              </div>
            </FormItem>
          </div>

          <FormItem
            name="description"
            :label="t('backlog.editForm.labels.description')"
            :rules="{validator: validateDesc}">
            <AsyncComponent :visible="showEditor">
              <RichEditor
                ref="descRichRef"
                :value="formState.description"
                :options="{placeholder: t('backlog.editForm.placeholders.taskDescription')}"
                :height="340"
                @change="editorChange"
                @loadingChange="editorLoading" />
            </AsyncComponent>
          </FormItem>
        </div>

        <div class="w-80  pl-2 border-l">
          <FormItem
            :label="t('backlog.editForm.labels.sprint')"
            name="sprintId">
            <Select
              v-model:value="formState.sprintId"
              :action="`${TESTER}/task/sprint?projectId=${props.projectId}&fullTextSearch=true`"
              :fieldNames="{ value: 'id', label: 'name' }"
              :readonly="!!props.taskId"
              showSearch
              internal
              :placeholder="t('backlog.editForm.placeholders.selectOrSearchSprint')"
              @change="sprintChange">
              <template #option="record">
                <div class="flex items-center" :title="record.name">
                  <Icon icon="icon-jihua" class="mr-1 text-4" />
                  <div style="max-width: 220px;" class="truncate">{{ record.name }}</div>
                </div>
              </template>
            </Select>
          </FormItem>

          <FormItem :label="t('backlog.editForm.labels.module')" name="moduleId">
            <TreeSelect
              v-model:value="formState.moduleId"
              :treeData="moduleTreeData"
              :fieldNames="{ value: 'id', label: 'name', children: 'children' }"
              :getPopupContainer="getPopupContainer"
              :virtual="false"
              size="small"
              showSearch
              allowClear
              :placeholder="t('backlog.editForm.placeholders.selectOrSearchModule')">
              <template #title="item">
                <div class="flex items-center" :title="item.name">
                  <Icon icon="icon-mokuai" class="mr-1 text-3.5" />
                  <div style="max-width: 220px;" class="truncate">{{ item.name }}</div>
                </div>
              </template>
            </TreeSelect>
          </FormItem>

          <FormItem :label="t('backlog.editForm.labels.parentTask')" name="parentTaskId">
            <Select
              v-if="!!props.parentTaskId"
              :readonly="true"
              :value="props.parentTaskId"
              :fieldNames="{ label: 'name', value: 'id' }"
              :action="`${TESTER}/task?projectId=${props.projectId}&fullTextSearch=true`">
              <template #option="record">
                <div class="flex items-center">
                  <IconTask :value="record.taskType?.value" class="text-4 flex-shrink-0" />
                  <span class="ml-1.5">{{ record.name }}</span>
                </div>
              </template>
            </Select>

            <Select
              v-else
              v-model:value="formState.parentTaskId"
              showSearch
              internal
              :placeholder="t('backlog.editForm.placeholders.selectParentTask')"
              :excludes="taskIdExcludes"
              :fieldNames="{ label: 'name', value: 'id' }"
              :action="`${TESTER}/task?projectId=${props.projectId}&fullTextSearch=true`">
              <template #option="record">
                <div class="flex items-center">
                  <IconTask :value="record.taskType?.value" class="text-4 flex-shrink-0" />
                  <span class="ml-1.5">{{ record.name }}</span>
                </div>
              </template>
            </Select>
          </FormItem>

          <FormItem
            name="evalWorkload"
            :rules="{ required: formState.actualWorkload, validator: evalWorkloadValidateDate, trigger: 'change' }">
            <template #label>
              {{
                evalWorkloadMethod === EvalWorkloadMethod.STORY_POINT
                  ? t('backlog.editForm.labels.evalStoryPoint')
                  : t('backlog.editForm.labels.evalWorkload')
              }}
              <Popover placement="rightTop">
                <template #content>
                  <div class="text-3 text-theme-sub-content max-w-75 leading-4">
                    {{
                      evalWorkloadMethod === EvalWorkloadMethod.STORY_POINT
                        ? t('backlog.editForm.labels.evalStoryPoint')
                        : t('backlog.editForm.labels.evalWorkload')
                    }}
                  </div>
                </template>
                <Icon icon="icon-tishi1" class="text-tips ml-1 cursor-pointer text-3.5" />
              </Popover>
            </template>
            <Input
              v-model:value="formState.evalWorkload"
              size="small"
              dataType="float"
              trimAll
              :min="0.1"
              :max="1000"
              :placeholder="t('backlog.editForm.placeholders.workloadRange')"
              @blur="evalWorkloadChange($event.target.value)" />
          </FormItem>

          <template v-if="!!props.taskId">
            <FormItem name="actualWorkload">
              <template #label>
                {{
                  evalWorkloadMethod === EvalWorkloadMethod.STORY_POINT
                    ? t('backlog.editForm.labels.evalStoryPoint')
                    : t('backlog.editForm.labels.evalWorkload')
                }}
                <Popover placement="rightTop">
                  <template #content>
                    <div class="text-3 text-theme-sub-content max-w-75 leading-4">
                      {{
                        evalWorkloadMethod === EvalWorkloadMethod.STORY_POINT
                          ? t('backlog.editForm.labels.evalStoryPoint')
                          : t('backlog.editForm.labels.evalWorkload')
                      }}
                    </div>
                  </template>
                  <Icon icon="icon-tishi1" class="text-tips ml-1 cursor-pointer text-3.5" />
                </Popover>
              </template>
              <Input
                v-model:value="formState.actualWorkload"
                class="w-70"
                size="small"
                dataType="float"
                trimAll
                :placeholder="t('backlog.editForm.placeholders.workloadRange')"
                :min="0.1"
                :max="1000"
                @change="actualWorkloadChange($event.target.value)" />
            </FormItem>
          </template>

          <FormItem
            name="softwareVersion"
            :label="t('backlog.editForm.labels.softwareVersion')">
            <Select
              v-model:value="formState.softwareVersion"
              allowClear
              :placeholder="t('backlog.editForm.placeholders.selectSoftwareVersion')"
              :action="`${TESTER}/software/version?projectId=${props.projectId}`"
              :params="{filters: [{value: [SoftwareVersionStatus.NOT_RELEASED, SoftwareVersionStatus.RELEASED], key: 'status', op: 'IN'}]}"
              :fieldNames="{value:'name', label: 'name'}">
            </Select>
          </FormItem>

          <FormItem
            name="tagIds"
            class="relative">
            <template #label>
              {{ t('backlog.editForm.labels.tags') }}<Popover placement="rightTop">
                <template #content>
                  <div class="text-3 text-theme-sub-content max-w-75 leading-4">
                    {{ t('backlog.editForm.descriptions.tags') }}
                  </div>
                </template>
                <Icon icon="icon-tishi1" class="text-tips ml-1 text-3.5" />
              </Popover>
            </template>
            <Select
              v-model:value="formState.tagIds"
              showSearch
              internal
              :fieldNames="{ label: 'name', value: 'id' }"
              :maxTagCount="5"
              :maxTagTextLength="15"
              :maxTags="5"
              :allowClear="false"
              :action="`${TESTER}/tag?projectId=${props.projectId}&fullTextSearch=true`"
              :placeholder="t('backlog.editForm.placeholders.maxTags')"
              mode="multiple"
              :notFoundContent="t('backlog.editForm.messages.contactAdminForTags')" />
          </FormItem>

          <FormItem
            name="refTaskIds"
            :label="t('backlog.editForm.labels.refTasks')"
            class="relative">
            <Select
              v-model:value="formState.refTaskIds"
              showSearch
              internal
              :allowClear="false"
              :fieldNames="{ label: 'name', value: 'id' }"
              :maxTagCount="10"
              :maxTagTextLength="15"
              :maxTags="20"
              :action="`${TESTER}/task?projectId=${props.projectId}&fullTextSearch=true`"
              :placeholder="t('backlog.editForm.placeholders.maxRefTasks')"
              mode="multiple">
              <template #option="record">
                <div class="flex items-center leading-4.5 overflow-hidden">
                  <IconTask :value="record.taskType?.value" class="text-4 flex-shrink-0" />
                  <div class="link truncate ml-1" :title="record.name">
                    {{ record.name }}
                  </div>
                  <div
                    v-if="record.overdue"
                    class="flex-shrink-0 border border-status-error rounded px-0.5 ml-2"
                    style="transform: scale(0.9);color: rgba(245, 34, 45, 100%);line-height: 16px;">
                    <span class="inline-block transform-gpu">{{ t('backlog.editForm.overdue') }}</span>
                  </div>
                </div>
              </template>
            </Select>
          </FormItem>

          <FormItem
            name="refCaseIds"
            :label="t('backlog.editForm.labels.refCases')"
            class="relative">
            <Select
              v-model:value="formState.refCaseIds"
              showSearch
              internal
              :allowClear="false"
              :fieldNames="{ label: 'name', value: 'id' }"
              :maxTagCount="10"
              :maxTagTextLength="15"
              :maxTags="20"
              :action="`${TESTER}/func/case?projectId=${props.projectId}&fullTextSearch=true`"
              :placeholder="t('backlog.editForm.placeholders.maxRefCases')"
              mode="multiple">
              <template #option="record">
                <div class="flex items-center leading-4.5 overflow-hidden">
                  <Icon icon="icon-gongnengyongli" class="text-4 flex-shrink-0" />
                  <div class="link truncate ml-1" :title="record.name">
                    {{ record.name }}
                  </div>
                  <div
                    v-if="record.overdue"
                    class="flex-shrink-0 border border-status-error rounded px-0.5 ml-2"
                    style="transform: scale(0.9);color: rgba(245, 34, 45, 100%);line-height: 16px;">
                    <span class="inline-block transform-gpu">{{ t('backlog.editForm.overdue') }}</span>
                  </div>
                </div>
              </template>
            </Select>
          </FormItem>

          <FormItem :label="t('backlog.editForm.labels.attachments')">
            <div
              style="height: 60px; border-color: rgba(0, 119, 255);background-color: rgba(0, 119, 255, 4%);"
              class="border border-dashed rounded flex flex-col px-2 py-1"
              :class="formState?.attachments?.length?'justify-between':'justify-center'">
              <template v-if="formState.attachments?.length">
                <div style="height: 286px;scrollbar-gutter: stable;" class="overflow-hidden hover:overflow-y-auto -mr-2 pr-1">
                  <div
                    v-for="(item,index) in formState.attachments"
                    :key="index"
                    :class="{'rounded-b':index===formState.attachments.length-1}"
                    class="flex items-center justify-between text-3 leading-3">
                    <div
                      :title="item.name"
                      class="truncate text-theme-sub-content leading-4 cursor-pointer"
                      style="width: 250px;">
                      {{ item.name }}
                    </div>
                    <Icon
                      icon="icon-qingchu"
                      class="text-theme-special text-theme-text-hover cursor-pointer flex-shrink-0 leading-4 text-3.5"
                      @click="delFile(index)" />
                  </div>
                </div>

                <div v-if="formState.attachments.length < 5" class="flex justify-end">
                  <Upload
                    :fileList="[]"
                    name="file"
                    class="-mb-1 mr-1"
                    :customRequest="() => {}"
                    @change="upLoad">
                    <Icon icon="icon-shangchuan" class="text-theme-special mr-1" />
                    <span class="text-3 leading-3 text-theme-text-hover">
                      {{ t('backlog.editForm.buttons.continueUpload') }}
                    </span>
                  </Upload>
                </div>
              </template>

              <template v-else>
                <div class="flex justify-center">
                  <Upload
                    name="file"
                    :fileList="[]"
                    :customRequest="() => {}"
                    @change="upLoad">
                    <Icon icon="icon-shangchuan" class="mr-1 text-theme-special" />
                    <span class="text-3 text-theme-text-hover">
                      {{ t('backlog.editForm.buttons.uploadAttachments') }}
                    </span>
                  </Upload>
                </div>
              </template>
            </div>
          </FormItem>
        </div>
      </div>
    </Form>

    <template #footer>
      <Button
        class="text-3 leading-3"
        size="small"
        @click="cancel">
        {{ t('backlog.editForm.buttons.cancel') }}
      </Button>
      <Button
        v-if="showContinue"
        type="primary"
        class="text-3 leading-3"
        size="small"
        :disabled="loading"
        @click="submit(true)">
        {{ t('backlog.editForm.buttons.saveAndContinue') }}
      </Button>
      <Button
        type="primary"
        class="text-3 leading-3"
        size="small"
        :disabled="loading"
        @click="submit(false)">
        {{ t('backlog.editForm.buttons.confirm') }}
      </Button>
    </template>
  </Modal>
</template>

<style scoped>
:deep(.ant-form-item-label) {
  max-width: 120px;
  font-size: 12px;
}

:deep(.ant-form-item:not(.ant-form-item-has-error)) {
  margin-bottom: 20px;
}

:deep(.ant-form-item .ant-form-item-has-error) {
  margin-bottom: 20px;
}

:deep(.ant-form-item-with-help .ant-form-item-explain) {
  min-height: 20px;
}
</style>
