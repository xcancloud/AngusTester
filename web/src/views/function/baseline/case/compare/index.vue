<script lang="ts" setup>
import { computed, defineAsyncComponent, onMounted, ref } from 'vue';
import { useI18n } from 'vue-i18n';
import { Button } from 'ant-design-vue';
import { AsyncComponent, Select } from '@xcan-angus/vue-ui';
import lodash from 'lodash-es';
import { func } from '@/api/tester';

const { t } = useI18n();

const CompareModal = defineAsyncComponent(() => import('./CompareModal.vue'));

type Props = {
  projectId: string;
  userInfo: { id: string; };
  appInfo: { id: string; };
  baselineId: string;
  planId: string;
}

const props = withDefaults(defineProps<Props>(), {
  projectId: undefined,
  userInfo: undefined,
  appInfo: undefined,
  baselineId: undefined,
  planId: undefined
});

const baselineList = ref([]);
const allCaseIds = ref<string[]>([]);
const compareVisible = ref(false);
const compareLineId = ref();
const baseCase = ref({});
const compareCase = ref({});

const baseLine = computed(() => {
  return baselineList.value.find(line => line.id === props.baselineId);
});

const loadBaseLineList = async () => {
  const [error, { data }] = await func.getBaselineList({
    pageSize: 2000,
    pageNo: 1,
    projectId: props.projectId
  });
  if (error) {
    return;
  }
  baselineList.value = data?.list || [];
  compareLineId.value = baselineList.value[0].id;
};

const loadBaseCase = async () => {
  const [error, { data }] = await func.getBaselineCaseList(props.baselineId, {
    pageSize: 2000,
    pageNo: 1,
    projectId: props.projectId
  });
  if (error) {
    return;
  }
  (data?.list || []).forEach(cases => {
    allCaseIds.value.push(cases.id);
    baseCase.value[cases.id] = cases;
  });
};

const loadCompareCase = async () => {
  const [error, { data }] = await func.getBaselineCaseList(compareLineId.value, {
    pageSize: 2000,
    pageNo: 1,
    projectId: props.projectId
  });
  if (error) {
    return;
  }
  allCaseIds.value = Object.keys(baseCase.value);
  (data?.list || []).forEach(cases => {
    if (!allCaseIds.value.includes(cases.id)) {
      allCaseIds.value.push(cases.id);
    }
    compareCase.value[cases.id] = cases;
  });
};

const handleChangeCompareLineId = () => {
  compareCase.value = {};
  loadCompareCase();
};

const selectCaseId = ref();
const openCompareModal = (caseId) => {
  compareVisible.value = true;
  selectCaseId.value = caseId;
};

onMounted(async () => {
  await loadBaseLineList();
  Promise.all([loadBaseCase(), loadCompareCase()])
    .then(() => {
      allCaseIds.value = lodash.uniq(allCaseIds.value);
    });
});

const leftRawConfig = [
  {
    title: '',
    dataIndex: 'idx',
    class: 'w-8 border-r text-center'
  },
  {
    title: t('functionBaseline.case.name'),
    dataIndex: 'name',
    class: 'flex-1 border-r'
  },
  {
    title: t('functionBaseline.case.versionNumber'),
    dataIndex: 'version',
    class: 'w-20'
  }
];

const rightRawConfig = [
  {
    title: t('functionBaseline.case.name'),
    dataIndex: 'name',
    class: 'flex-1 border-r'
  },
  {
    title: t('functionBaseline.case.versionNumber'),
    dataIndex: 'version',
    class: 'w-20 border-r'
  },
  {
    title: t('functionBaseline.case.operation'),
    dataIndex: 'action',
    class: 'w-20 text-center'
  }
];
</script>
<template>
  <div class="overflow-y-auto -mt-4">
    <div class="flex border-b border-l border-r">
      <div class="flex-1 leading-8  border-r">
        <div class="text-center">
          {{ baseLine?.name }}
        </div>
      </div>
      <div class="flex-1 leading-8">
        <div class="text-center px-1">
          <Select
            v-model:value="compareLineId"
            class="w-full"
            :options="baselineList"
            :fieldNames="{
              value: 'id',
              label: 'name'
            }"
            @change="handleChangeCompareLineId" />
        </div>
      </div>
    </div>

    <div class="flex border-b  border-l border-r">
      <div class="flex-1 leading-8 border-r">
        <div class="text-center flex">
          <div
            v-for="leftRaw in leftRawConfig"
            :key="leftRaw.dataIndex"
            class="bg-gray-bg"
            :class="leftRaw.class">
            {{ leftRaw.title }}
          </div>
        </div>
      </div>
      <div class="flex-1 leading-8">
        <div class="text-center flex">
          <div
            v-for="rightRaw in rightRawConfig"
            :key="rightRaw.dataIndex"
            class="bg-gray-bg"
            :class="rightRaw.class">
            {{ rightRaw.title }}
          </div>
        </div>
      </div>
    </div>

    <div
      v-for="(caseId, idx) in allCaseIds"
      :key="caseId"
      class="flex leading-8 border-b  border-l border-r">
      <div class="flex-1 leading-8 border-r flex">
        <div
          v-for="(leftRaw) in leftRawConfig"
          :key="leftRaw.dataIndex"
          :class="leftRaw.class"
          class="px-1">
          <tmplate v-if="leftRaw.dataIndex === 'version'">
            <span v-if="baseCase[caseId]?.[leftRaw.dataIndex]">v{{ baseCase[caseId][leftRaw.dataIndex] }}</span>
          </tmplate>
          <template v-else-if="leftRaw.dataIndex === 'idx'">
            {{ idx + 1 }}
          </template>
          <template v-else>
            {{ baseCase[caseId]?.[leftRaw.dataIndex] }}
          </template>
        </div>
      </div>
      <div class="flex-1 leading-8  flex" :class="{'bg-status-add': !baseCase[caseId] && compareCase[caseId], 'bg-status-del': baseCase[caseId] && !compareCase[caseId]}">
        <div
          v-for="rightRaw in rightRawConfig"
          :key="rightRaw.dataIndex"
          :class="rightRaw.class"
          class="px-1">
          <tmplate v-if="rightRaw.dataIndex === 'version'">
            <span v-if="compareCase[caseId]?.[rightRaw.dataIndex]">v{{ compareCase[caseId][rightRaw.dataIndex] }}</span>
          </tmplate>
          <tmplate v-else-if="rightRaw.dataIndex === 'action'">
            <Button
              v-if="compareCase[caseId] && baseCase[caseId]"
              type="link"
              size="small"
              @click="openCompareModal(caseId)">
              {{ t('functionBaseline.case.compare') }}
            </Button>
          </tmplate>
          <template v-else>
            {{ compareCase[caseId]?.[rightRaw.dataIndex] }}
          </template>
        </div>
      </div>
    </div>

    <AsyncComponent :visible="compareVisible">
      <CompareModal
        v-model:visible="compareVisible"
        :baselineId="props.baselineId"
        :compareBaselineId="compareLineId"
        :caseId="selectCaseId"
        :projectId="props.projectId" />
    </AsyncComponent>
  </div>
</template>
