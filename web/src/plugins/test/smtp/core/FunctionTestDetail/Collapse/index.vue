<script setup lang="ts">
import { computed, defineAsyncComponent, ref } from 'vue';
import { Collapse, CollapsePanel } from 'ant-design-vue';
import { Arrow } from '@xcan-angus/vue-ui';
import { utils } from '@xcan-angus/infra';
import { useI18n } from 'vue-i18n';

import StatusTag from '@/plugins/test/components/StatusTag/index.vue';
import { ExecInfo } from '../PropsType';
import { ExecContent } from '@/plugins/test/types';

const { t } = useI18n();

interface Props {
  iterations:string;
  ignoreAssertions:boolean;
  pipelines:ExecInfo['task']['pipelines'];
  execContent:ExecContent[];
}

const props = withDefaults(defineProps<Props>(), {
  iterations: undefined,
  ignoreAssertions: false,
  pipelines: () => [],
  execContent: () => []
});
const Smtp = defineAsyncComponent(() => import('./Smtp/index.vue'));

const UUID = utils.uuid();
const collapseActiveKey = ref<string>(UUID);
const arrowOpen = ref(collapseActiveKey.value === UUID);

const arrowChange = (open:boolean) => {
  arrowOpen.value = open;
  if (open) {
    collapseActiveKey.value = UUID;
    return;
  }

  collapseActiveKey.value = undefined;
};

const status = computed(() => {
  if (!props.execContent?.length) {
    return 'block';
  }

  const totalNum = props.execContent.length;
  const successNum = props.execContent.filter(item => item.content?.success).length;
  return totalNum === successNum ? 'success' : 'fail';
});
</script>
<template>
  <Collapse
    :activeKey="collapseActiveKey"
    :bordered="false"
    style="background-color: #fff;font-size: 12px;"
    class="timeline-collapse">
    <CollapsePanel
      :key="UUID"
      :showArrow="false"
      collapsible="disabled">
      <template #header>
        <div class="w-full flex items-center">
          <div class="min-w-20 mr-3">{{ t('common.iterationCountTemplate', { iteration: props.iterations }) }}</div>
          <StatusTag :value="status" class="mr-3" />
          <Arrow :open="arrowOpen" @change="arrowChange" />
        </div>
      </template>

      <div class="space-y-3">
        <template v-for="item in props.pipelines" :key="item.id">
          <template v-if="!item.transactionName">
            <Smtp
              :value="item"
              :content="props.execContent"
              :ignoreAssertions="props.ignoreAssertions" />
          </template>
        </template>
      </div>
    </CollapsePanel>
  </Collapse>
</template>

<style scoped>
.timeline-collapse.ant-collapse>.ant-collapse-item {
  border: none;
}

.timeline-collapse.ant-collapse>.ant-collapse-item>:deep(.ant-collapse-content) > .ant-collapse-content-box {
  padding: 8px 0;
}

.ant-collapse > :deep(.ant-collapse-item) > .ant-collapse-header {
  padding-right: 0;
  padding-left: 0;
  line-height: 20px;
}
</style>
